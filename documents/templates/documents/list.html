{% extends "documents/base.html" %}
{% block title %}Documents · Document Analyzer{% endblock %}

{% block content %}
<div class="flex flex-wrap items-end justify-between gap-4">
    <div>
        <h1 class="text-xl font-semibold">Documents</h1>
        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
            Upload, classify, summarize — all local.
        </p>
    </div>

    <div class="flex flex-col gap-1">
        <button class="btn" type="submit" form="combineForm">
            Combine &amp; Summarize
        </button>
        <span class="text-xs text-slate-500 dark:text-slate-400">
            Create a notebook from selected documents
        </span>
    </div>

</div>

<!-- Filter + Export -->
<form method="get" class="mt-4 flex flex-wrap items-center gap-2">
    <label class="text-sm font-medium">Type</label>
    <select name="type" class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm
                 dark:border-slate-700 dark:bg-slate-900">
        <option value="">All</option>
        {% for t in type_choices %}
        <option value="{{ t }}" {% if dtype == t %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
    </select>

    <button class="btn-outline" type="submit">Apply</button>

    {% if dtype %}
    <a class="btn-outline" href="{% url 'documents:list' %}">Reset</a>
    {% endif %}

    <a class="btn-outline" href="{% url 'documents:export_csv' %}{% if dtype %}?type={{ dtype }}{% endif %}">
        Export CSV
    </a>
</form>

<!-- ================= Combine Form ================= -->
<form id="combineForm" method="post" action="{% url 'documents:combined_create' %}">
    {% csrf_token %}

    <div class="card mt-5 overflow-hidden">
        {% if docs %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-200">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold">Select</th>
                        <th class="px-4 py-3 text-left font-semibold">File</th>
                        <th class="px-4 py-3 text-left font-semibold">Type</th>
                        <th class="px-4 py-3 text-left font-semibold">Words</th>
                        <th class="px-4 py-3 text-left font-semibold">Uploaded</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
                    {% for d in docs %}
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-900">
                        <td class="px-4 py-3">
                            <input type="checkbox" name="doc_ids" value="{{ d.id }}" class="h-4 w-4 rounded border-slate-300
                                dark:border-slate-700">
                        </td>

                        <td class="px-4 py-3">
                            <a class="font-medium text-blue-700 hover:underline dark:text-blue-300"
                                href="{% url 'documents:detail' d.pk %}">
                                {{ d.file_name }}
                            </a>
                        </td>

                        <td class="px-4 py-3">
                            <span class="inline-flex rounded-full bg-slate-100 px-2 py-1 text-xs font-medium
                               dark:bg-slate-800">
                                {{ d.document_type }}
                            </span>
                        </td>

                        <td class="px-4 py-3">{{ d.word_count }}</td>
                        <td class="px-4 py-3">{{ d.uploaded_at }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-6 text-sm text-slate-500 dark:text-slate-400">
            No documents yet. Click “Upload” to add one.
        </div>
        {% endif %}
    </div>
</form>
<script>
    const checkboxes = document.querySelectorAll('input[name="doc_ids"]');
    const combineBtn = document.querySelector('button[form="combineForm"]');

    function updateCombineState() {
        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
        combineBtn.disabled = checked < 2;
        combineBtn.classList.toggle("opacity-50", checked < 2);
        combineBtn.classList.toggle("cursor-not-allowed", checked < 2);
    }

    checkboxes.forEach(cb => cb.addEventListener("change", updateCombineState));
    updateCombineState();
</script>

{% endblock %}