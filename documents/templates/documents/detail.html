{% extends "documents/base.html" %}
{% block title %}Detail · Document Analyzer{% endblock %}

{% block content %}
<div class="grid grid-cols-1 gap-5 lg:grid-cols-3">
    <div class="p-6 lg:col-span-1">
        <h1 class="text-lg font-semibold">Document</h1>
        <dl class="mt-4 space-y-2 text-sm">
            <div class="flex justify-between gap-3">
                <dt class="text-slate-500 dark:text-slate-400">File</dt>
                <dd class="font-medium text-right truncate">{{ doc.file_name }}</dd>
            </div>
            <div class="flex justify-between gap-3">
                <dt class="text-slate-500 dark:text-slate-400">Ext</dt>
                <dd class="text-right">{{ doc.file_ext }}</dd>
            </div>
            <div class="flex justify-between gap-3">
                <dt class="text-slate-500 dark:text-slate-400">MIME</dt>
                <dd class="text-right truncate">{{ doc.mime_type }}</dd>
            </div>
            <div class="flex justify-between gap-3">
                <dt class="text-slate-500 dark:text-slate-400">Type</dt>
                <dd class="text-right">{{ doc.document_type }}</dd>
            </div>
            <div class="flex justify-between gap-3">
                <dt class="text-slate-500 dark:text-slate-400">Words</dt>
                <dd class="text-right">{{ doc.word_count }}</dd>
            </div>
            <div class="flex justify-between gap-3">
                <dt class="text-slate-500 dark:text-slate-400">Chars</dt>
                <dd class="text-right">{{ doc.char_count }}</dd>
            </div>
            <div class="flex justify-between gap-3">
                <dt class="text-slate-500 dark:text-slate-400">Uploaded</dt>
                <dd class="text-right">{{ doc.uploaded_at|date:"j M Y H:i" }}</dd>
            </div>
        </dl>

        <div class="mt-5 flex flex-wrap gap-2">
            <a class="btn-outline" href="{% url 'documents:file' doc.pk %}" target="_blank" rel="noopener">
                View File
            </a>
            <form method="post" action="{% url 'documents:reprocess' doc.pk %}">
                {% csrf_token %}
                <button class="btn-outline" type="submit">Reprocess</button>
            </form>
            <a class="btn" href="{% url 'documents:chat_document' doc.pk %}">Chat about this document</a>
        </div>
    </div>

    <div class="lg:col-span-2 space-y-5">
        <div class="card p-6">
            <h2 class="text-lg font-semibold">Summary</h2>
            <p class="mt-3 text-sm leading-relaxed text-slate-700 dark:text-slate-200">
                {% if doc.summary %}
                {{ doc.summary }}
                {% else %}
                (summary not available)
                {% endif %}
            </p>
        </div>

        <div class="card p-6">
            <h2 class="text-lg font-semibold">Status</h2>

            <div class="mt-3 flex items-start justify-between gap-4">
                <div class="min-w-0">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-slate-500 dark:text-slate-400">Status</span>

                        {% with s=doc.status|default_if_none:"" %}
                        {% if s == "done" %}
                        <span
                            class="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700 dark:bg-emerald-950/40 dark:text-emerald-200">
                            ✓ Done
                        </span>
                        {% elif s == "processing" %}
                        <span
                            class="inline-flex items-center gap-2 rounded-full bg-blue-50 px-3 py-1 text-xs font-semibold text-blue-700 dark:bg-blue-950/40 dark:text-blue-200">
                            <span
                                class="inline-block h-3 w-3 animate-spin rounded-full border-2 border-blue-300 border-t-blue-700 dark:border-blue-800 dark:border-t-blue-200"></span>
                            Processing
                        </span>
                        {% elif s == "queued" %}
                        <span
                            class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700 dark:bg-slate-800 dark:text-slate-200">
                            • Queued
                        </span>
                        {% elif s == "failed" or doc.error %}
                        <span
                            class="inline-flex items-center gap-1 rounded-full bg-red-50 px-3 py-1 text-xs font-semibold text-red-700 dark:bg-red-950/40 dark:text-red-200">
                            ! Failed
                        </span>
                        {% else %}
                        <span
                            class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700 dark:bg-slate-800 dark:text-slate-200">
                            {{ s|default:"unknown" }}
                        </span>
                        {% endif %}
                        {% endwith %}
                    </div>

                    <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">
                        {% if doc.error %}
                        The system encountered an error while processing this document.
                        {% elif doc.status == "done" %}
                        Extraction and summary are ready.
                        {% elif doc.status == "processing" %}
                        Please wait—this may take a moment depending on file size.
                        {% elif doc.status == "queued" %}
                        This document is queued and will start processing soon.
                        {% else %}
                        Current state: {{ doc.status|default:"unknown" }}.
                        {% endif %}
                    </p>
                </div>
            </div>

            {% if doc.error %}
            <div class="mt-4 rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-700
                dark:border-red-900/60 dark:bg-red-950/40 dark:text-red-200">
                <div class="font-semibold">Error</div>
                <div class="mt-1 whitespace-pre-wrap">{{ doc.error }}</div>
            </div>
            {% endif %}
        </div>

        <div class="card p-6">
            <h2 class="text-lg font-semibold">Preview</h2>
            <pre
                class="mt-3 whitespace-pre-wrap rounded-xl bg-slate-100 p-4 text-xs text-slate-800 dark:bg-slate-950 dark:text-slate-200">{{ doc.extracted_text|truncatechars:1800|default:"(not extracted yet)" }}</pre>
        </div>
    </div>
</div>
{% endblock %}